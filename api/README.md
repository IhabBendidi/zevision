**Face Recognition API** is designed to get predictions generated by the Face Recognition service and update the underlying model: add, update or remove [categories](category_names.md) the model is capable to recognize.

_Current API version: 0.1.2_


# Starting the API server

## Production

In production environment, run the following command to start the API server:

```
python3 -m api.server
```

By default, Flask starts the server on port 5000. One can specify a different port using the `--port` option.

## Development

In development environment, a lightweight Flask server with live-reload is available:

```
flask run
```

## Docker

An example of `docker run` with custom bind mounts would look like follows:

```
docker run -d -p 5000:5000 --restart=always \
  --mount type=bind,source=/var/log/face_recognition,target=/opt/face_recognition/logs \
  --mount type=bind,source=/opt/face_recognition/models,target=/opt/face_recognition/models \
  --mount type=bind,source=/data/face_recognition,target=/opt/face_recognition/data \
  face-recognition
```

Where `face-recognition` is the docker image of the API server.


# API Endpoints

The API exposes the following endpoints:


## GET /face_recognition/status

Return model status.
Could be used to track training failures, model update progress and model availability.

**Output**:

```json
{
    "current": {
        "version": "0.0.0",
        "timestamp": "2019-05-10T12:24:47.990Z",
        "recognition_method": "hog"
    },
    "failed": {
        "version": "0.0.0",
        "timestamp": "2019-05-10T12:24:47.990Z",
        "recognition_method": "hog",
        "error": "Error message"
    },
    "pending": {
        "version": "0.0.0",
        "timestamp": "2019-05-10T12:24:47.990Z",
        "recognition_method": "hog"
    }
}
```

Except for the initial training, `current` model status info is always present.
It describes the model currently in use.

On subsequent model updates, a `pending` field is appended to the status.
This is the information about the model currently being (re-)trained.
Once the training is finished, this model will replace the previously `current` one.
At this point, the `pending` field will no longer appear in the output.

If the training process crashes, a `failed` field will be appended to the output, describing the model that failed to build with the exception message.
In this case, if a previously `current` model is available, it will still be in use.

If there is no model ready for predictions, the response is an empty JSON object: `{}`.

**Example**:

```
$ curl /face_recognition/status
```


## GET /face_recognition/categories

List categories known by the model.
In case a training is still running, new categories are returned as well.

**Output**:

```json
[
    "duke_raoul",
    "dr_gonzo"
]
```

Note that the sort order is not guaranteed.

**Example**:

```
$ curl /face_recognition/categories
```


## PUT /face_recognition/categories

Add new categories data to the model.

**Input**:

- `data`, image files.
In order to have an acceptable prediction quality, make sure each category has at least 6 to 8 samples.
Note that the number of samples should be well-ballanced between categories.

- `categories`, json file.
Must contain a list of categories mapping category names to corresponding image files.
The following structure is expected:
```json
[{
    "data": [
        "image1.jpg",
        "image2.jpg"
    ],
    "category": "ihab_bendidi"
}]
```

**Output**:

If the operation was successfull, a _**201**: Created_ is returned.


**Example**:

```
$ curl -X PUT /face_recognition/categories -F "data=@image1.jpg" -F "data=@image2.jpg" -F 'categories=@categories.json;type=application/json'
```

**Errors**:

- _**400**: Bad request._
Unable to parse `categories.json` or it doesn't have the expected structure.

- _**404**: Not found._
One or several uploaded files have no mapping in the `categories.json` counterpart.

- _**409**: Conflict._
Specified category already exists.
In order to add new data to an existing category, use [`PATCH /face_recognition/categories/{category}`](#update_category) endpoint.


<a name=#update_category></a>
## PATCH /face_recognition/categories/{category}

Add new data to an existing category.

**Input**:

- `data`, image file.
Multiple images can be added to the same category simultaneously.

**Output**:

If the operation was successfull, a _**204**: No Content_ is returned.


**Example**:

```
$ curl -X PATCH /face_recognition/categories/linus_benjamin -F "data=@image1.jpg" -F "data=@image2.jpg"
```

**Errors**:

- _**404**: Not found._
Specified category doesn't exist.


## DELETE /face_recognition/categories/{category}

Remove one category at a time from the model.
All data related to this category, including processed images, will be erased.


**Output**:

If the operation was successfull, a _**204**: No Content_ is returned.


**Example**:

```
$ curl -X DELETE /face_recognition/categories/beckett_samuel
```

**Errors**:

- _**404**: Not found._
Specified category doesn't exist.


## GET /face_recognition/retrain

Retrain the model without any data change.
One can use this endpoint for example to train a model on a large dataset that was mounted in `/data` folder instead of explicitly upload files via API.


**Output**:

If the operation was successfull, a _**204**: No Content_ is returned.


**Example**:

```
$ curl /face_recognition/retrain
```


## POST /face_recognition/prediction

Get model predictions.
By default, only the best prediction for each detected face is returned.

**Input**:

- `data` - image file.
The endpoint expects only one image passed as `data`.
Otherwise, only the first image will be used for predictions.

**Output**:

```json
[{
    "category": "poirot_hercule",
    "probability": 0.0,
    "box": {
        "top": 0,
        "left": 0,
        "height": 0,
        "width": 0
    }
}]
```
Where:
- `category` - Recognized category - a person's name.
- `probability` - Prediction probability, a number between `0` and `1`. The closer this value is to 1, the more confident the model is about the prediction made.
- `box` - Detected face coordinates on the image.


 **Example**:

 ```
 $ curl -X POST /face_recognition/prediction -F "data=@image.jpg"
 ```

**Errors**:

- _**400**: Bad request_.
The required `data` is not provided.


## Notes

- In addition to the errors specified for each endpoint, all endpoints may return _**500**: Server error_ which indicates an unhandled exception.

- All endpoints returning some json data accept an optional `pretty` parameter:

```
$ curl /face_recognition/categories?pretty
```
